# 皮皮监控工具 - 系统开发文档

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0.2 | 2026-02-02 | 修复：只检测非零退出码为进程崩溃 |
| 1.0.1 | 2026-02-02 | 修复：每次分析前重置错误计数器 |
| 1.2.0 | 2026-02-01 | 初始版本 |

## 项目概述

皮皮监控工具（Pipi Monitor）用于监控 OpenClaw Gateway 的健康状态，自动重启挂掉的服务，分析日志错误，管理配置文件。

## 目录结构

```
E:\pipi\workspace\pipi-monitor\
├── src/                 # 源代码
│   ├── index.js         # 主程序入口
│   ├── config.js        # 配置常量
│   ├── health.js        # 健康检查模块
│   ├── analyzer.js      # 日志分析模块
│   ├── configManager.js # 配置管理模块
│   └── logger.js        # 日志工具
├── docs/                # 开发文档
├── dist/                # 打包输出
└── package.json         # 项目配置
```

## 模块说明

### 1. index.js - 主程序
- 启动监控服务
- 定时执行健康检查（默认30秒）
- 协调各模块工作

### 2. health.js - 健康检查
- `checkAPI()` - 检查 Gateway API 是否可访问
- `checkProcess()` - 检查 node 进程是否存活
- `restartGateway()` - 重启 Gateway 进程

### 3. analyzer.js - 日志分析
- 读取 session 日志文件
- 识别错误模式：401认证、端口冲突、崩溃等

### 4. configManager.js - 配置管理
- `load()` - 加载配置
- `backup()` - 备份配置
- `restore()` - 恢复配置
- `listBackups()` - 列出备份版本

### 5. logger.js - 日志工具
- 写入日志到 `E:\pipi\logs\`
- 按日期分文件

## 开发指南

### 环境要求
- Node.js 18+
- Windows Server

### 安装依赖
```bash
cd E:\pipi\workspace\pipi-monitor
npm install
```

### 开发运行
```bash
npm run dev
```

### 打包
```bash
npm run build
```

输出：`dist/pimonitor.exe`

## 服务管理

### 启动/停止
```powershell
net start PipiMonitor
net stop PipiMonitor
```

### 查看状态
```powershell
Get-Service PipiMonitor
```

### 查看日志
```powershell
Get-Content E:\pipi\logs\pipi-monitor-$(Get-Date -Format 'yyyy-MM-dd').log -Tail 20
```

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0.0 | 2026-02-01 | 初始版本 |
| 1.1.0 | 2026-02-01 | 添加 nssm 重启、配置备份 |
| 1.2.0 | 2026-02-01 | 改用直接启动进程、修复日志乱码 |
